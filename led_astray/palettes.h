#pragma once


#define ARRAY_SIZE(A) (sizeof(A) / sizeof((A)[0]))

DEFINE_GRADIENT_PALETTE (bhw4_029_gp) 
{
    0,  28,  7, 75,
   43,  73, 22, 74,
   79, 177,146,197,
  122,  21, 72,137,
  165,  15,184, 75,
  255, 224,205,  4
};


DEFINE_GRADIENT_PALETTE( Sunset_Real_gp ) 
{
    0, 120,  0,  0,
   22, 179, 22,  0,
   51, 255,104,  0,
   85, 167, 22, 18,
  135, 100,  0,103,
  198,  16,  0,130,
  255,   0,  0,160};

DEFINE_GRADIENT_PALETTE( purplefly_gp ) 
{
    0,   0,  0,  0,
   63, 239,  0,122,
  191, 252,255, 78,
  255,   0,  0,  0};

DEFINE_GRADIENT_PALETTE( GMT_sealand_gp ) 
{
    0,  53, 33,255,
   14,  23, 33,255,
   28,  23, 68,255,
   42,  23,115,255,
   56,  23,178,255,
   70,  23,255,255,
   84,  23,255,170,
   99,  23,255,103,
  113,  23,255, 56,
  127,  23,255, 25,
  141,  53,255, 25,
  155, 100,255, 25,
  170, 167,255, 25,
  170, 255,255, 87,
  184, 255,193, 87,
  198, 255,141, 87,
  212, 255, 99, 87,
  226, 255,115,135,
  240, 255,135,182,
  255, 255,156,223};

DEFINE_GRADIENT_PALETTE( bcyr_gp ) 
{
    0,   0,  0,255,
   84,   0,255,255,
  170, 255,255,  0,
  255, 255,  0,  0};

DEFINE_GRADIENT_PALETTE( GMT_seafloor_gp ) 
{
    0,  25,  0,109,
   10,  28,  0,119,
   21,  32,  0,127,
   31,  35,  0,140,
   42,  27,  1,145,
   53,  20,  1,151,
   74,  14,  4,156,
   84,   9,  9,164,
   95,   5, 15,170,
  106,   2, 24,176,
  116,   1, 35,182,
  138,   1, 49,188,
  148,   0, 66,197,
  159,   1, 79,203,
  170,   3, 93,210,
  180,  10,109,216,
  191,  24,128,223,
  212,  43,149,230,
  223,  72,173,240,
  233, 112,197,247,
  244, 163,225,255,
  255, 220,248,255};

DEFINE_GRADIENT_PALETTE( mby_gp ) 
{
    0,   0,  0, 14,
   39,   0,  2, 24,
   78,   0,  7, 25,
  107,   1, 38, 79,
  153,   1, 68,147,
  155,  48,159,242,
  156,  97,195,255,
  156,   0, 30, 10,
  157,   1, 51,  3,
  166, 199,173, 42,
  180,  79, 13,  0,
  192,  44,  2,  1,
  211,  77, 92, 80,
  235, 146,159,149,
  255, 255,255,255};


DEFINE_GRADIENT_PALETTE( jet_gp ) 
{
    0,   0,  0,123,
   17,   0,  0,255,
   33,   0, 11,255,
   51,   0, 55,255,
   68,   0,135,255,
   84,   0,255,255,
  102,   6,255,255,
  119,  41,255,123,
  135, 120,255, 44,
  153, 255,255,  7,
  170, 255,255,  0,
  186, 255,135,  0,
  204, 255, 55,  0,
  221, 255, 11,  0,
  237, 255,  0,  0,
  255, 120,  0,  0};


DEFINE_GRADIENT_PALETTE( spellbound_gp ) 
{
    0, 232,235, 40,
   12, 157,248, 46,
   25, 100,246, 51,
   45,  53,250, 33,
   63,  18,237, 53,
   81,  11,211,162,
   94,  18,147,214,
  101,  43,124,237,
  112,  49, 75,247,
  127,  49, 75,247,
  140,  92,107,247,
  150, 120,127,250,
  163, 130,138,252,
  173, 144,131,252,
  186, 148,112,252,
  196, 144, 37,176,
  211, 113, 18, 87,
  221, 163, 33, 53,
  234, 255,101, 78,
  247, 229,235, 46,
  255, 229,235, 46};

DEFINE_GRADIENT_PALETTE( bhw1_06_gp ) 
{
    0, 184,  1,128,
  160,   1,193,182,
  219, 153,227,190,
  255, 255,255,255};


DEFINE_GRADIENT_PALETTE( bhw1_05_gp ) 
{
    0,   1,221, 53,
  255,  73,  3,178};

DEFINE_GRADIENT_PALETTE( Primary_3_gp ) 
{
    0,  16, 82,255,
   63,  91,156,103,
  127, 255,255, 25,
  191, 255,105, 34,
  255, 255, 23, 45};

DEFINE_GRADIENT_PALETTE( Romanian_flag_smooth_gp ) 
{
    0,   0,  0,255,
   63,  42, 55, 45,
  127, 255,255,  0,
  191, 255, 55,  0,
  255, 255,  0,  0};

DEFINE_GRADIENT_PALETTE( bhw2_39_gp )
{
    0,   2,184,188,
   33,  56, 27,162,
   66,  56, 27,162,
  122, 255,255, 45,
  150, 227, 65,  6,
  201,  67, 13, 27,
  255,  16,  1, 53};


DEFINE_GRADIENT_PALETTE( bhw2_grrrrr_gp )
{
    0, 184, 15,155,
   35,  78, 46,168,
   84,  65,169,230,
  130,   9,127,186,
  163,  77,182,109,
  191, 242,246, 55,
  216, 142,128,103,
  255,  72, 50,168};

DEFINE_GRADIENT_PALETTE( bhw2_turq_gp ) 
{
    0,   1, 33, 95,
   38,   1,107, 37,
   76,  42,255, 45,
  127, 255,255, 45,
  178,  42,255, 45,
  216,   1,107, 37,
  255,   1, 33, 95};

DEFINE_GRADIENT_PALETTE( bhw3_13_gp )
{
    0,   3,  6, 72,
   38,  12, 50,188,
  109, 217, 35,  1,
  135, 242,175, 12,
  178, 161, 32, 87,
  255,  24,  6,108};


DEFINE_GRADIENT_PALETTE( bhw3_01_gp )
{
    0, 255,146,228,
   25, 152, 43, 65,
   48,  36, 17, 22,
   72,   8, 34, 75,
   81,   1, 58,170,
  104,  42, 49,245,
  124,  15, 15, 95,
  150,   1,  8, 39,
  175,  98, 32, 35,
  204, 123,  9,  2,
  219, 220, 15,  2,
  237, 255, 93,  6,
  255, 244,244,  0};

DEFINE_GRADIENT_PALETTE( highish )
{
    0, 140, 140, 255,
  127, 200, 255, 255,
  255, 255, 255, 255};
  

typedef CRGBPalette16 PaletteList[];
PaletteList palette_list = {
    //bhw4_029_gp,
    Sunset_Real_gp,
    purplefly_gp,
    GMT_sealand_gp,
    bcyr_gp,
    GMT_seafloor_gp,
    mby_gp,
    jet_gp,
    spellbound_gp,
    bhw1_06_gp,
    bhw1_05_gp,
    Primary_3_gp,
    Romanian_flag_smooth_gp,
    bhw2_39_gp,
    bhw2_grrrrr_gp,
    bhw2_turq_gp,
    bhw3_13_gp,
    bhw3_01_gp};


    
// color palette blending courtesy:
    // https://gist.github.com/kriegsman/1f7ccbbfa492a73c015e

class PaletteBlender
{
public:

    PaletteBlender (int blend_rate = 24): _blend_rate (blend_rate) 
    {
      *_palette = CRGB::Black;
      next ();
    };
    
    ~PaletteBlender () = default;

    CRGBPalette16* get_palette () 
    {
      return &_palette;
    };

    void blend_palette ()
    {
      nblendPaletteTowardPalette (_palette, _next_palette, _blend_rate);
    };

    void next ()
    {
      _palette_idx = random8 () % ARRAY_SIZE (palette_list);
      _next_palette = palette_list[_palette_idx];
    };

  

private:
    CRGBPalette16 _palette;
    CRGBPalette16 _next_palette;
    int           _blend_rate;    
    int           _palette_idx;
};




class PaletteMap
{
public:

    PaletteMap ()
    {
      _blender = new PaletteBlender ();
      *_palette = CRGB::Black;
      //_palette_width = 512 / ARRAY_SIZE (palette_list);
    };
    
    ~PaletteMap () = default;

    void update_palette (int value) 
    {
      
      if (value < 255) {
        // in the first quarter of the range return a high temperature palette
        _palette = highish;
      } else if (value < 511) {
        // in the second quarter of the range return the full blackbody palette
        _palette = HeatColors_p;
      } else if (value < 767) {
        // in the third quarter, return a low temperature palette
        _palette = LavaColors_p;
      } else {
        // otherwise roll through random palettes
        
        _palette = *_blender->get_palette ();
        // in the second half, get the closest palette from the list
        //int idx = (value - 512) / _palette_width;
        //Serial.println (idx);
        //_palette = palette_list[idx];
      }
    };

    
    CRGBPalette16* get_palette () 
    {  
      return &_palette;
    };

    PaletteBlender* _blender;


private:

    
    CRGBPalette16   _palette;
    int             _palette_width;


};






















    
